好！以**正方形等距网格 + P1（更准确说是 Q1：双线性）基 + Galerkin**为例，从积分方程一路推到离散线性方程的系数。记住这一条主线：

$$
B(x)=E(x)+\rho(x)\int_{S}G(x,y)\,V(x,y)\,B(y)\,dA_y,
$$

$$
\text{求 }B_h(x)=\sum_{j}b_j\,\phi_j(x)\ \text{满足}\ \int_S\phi_i(x)\,B_h(x)\,dA_x
=\int_S\phi_i E\,dA_x+\int_S\phi_i(x)\,\rho(x)\!\int_S G(x,y)V(x,y)B_h(y)\,dA_y\,dA_x .
$$

把 $B_h$ 展开并整理，得到**标准 Galerkin 形式**：

$$
\underbrace{\sum_j \Big[\int_S \phi_i(x)\phi_j(x)\,dA_x\Big]}_{M_{ij}}\,b_j
=\underbrace{\int_S \phi_i(x)E(x)\,dA_x}_{f_i}
+\sum_j\underbrace{\int_S\!\!\int_S \phi_i(x)\rho(x)\,G(x,y)V(x,y)\,\phi_j(y)\,dA_y dA_x}_{K_{ij}}\,b_j .
$$

等价写成

$$
(M-K)\,b=f.
$$

---

# 1) 网格与基函数（Q1 双线性）

把每个正方形单元 $e$ 映射自参考方形 $(\xi,\eta)\in[0,1]^2$，边长 $h$，Jacobian $J_e=h^2$。单元四个顶点的局部形函数（Q1）：

$$
N_1=(1-\xi)(1-\eta),\quad N_2=\xi(1-\eta),\quad N_3=(1-\xi)\eta,\quad N_4=\xi\eta .
$$

全局基 $\phi_j$ 是节点“帽函数”，在覆盖它的最多 4 个单元上等于相应的 $N_a$，在别处为 0。

---

# 2) 质量矩阵 $M$（单元一致公式）

单元一致质量矩阵（把 $N_aN_b$ 在 $[0,1]^2$ 上积分，再乘 $h^2$）：

$$
M^{(e)}=\frac{h^2}{36}
\begin{bmatrix}
4&2&2&1\\
2&4&1&2\\
2&1&4&2\\
1&2&2&4
\end{bmatrix},
\qquad
M=\sum_{e}\mathcal{A}_e^\top M^{(e)}\mathcal{A}_e,
$$

$\mathcal{A}_e$ 为从局部 $(1..4)$ 节点到全局自由度的装配映射。
（若需要更“解线性方程友好”，可做**质量集块/质量集总（lumping）**：把 $M$ 近似成对角，其对角为各行和。）

---

# 3) 右端 $f$（发射项）

$$
f_i=\int_S \phi_i(x)\,E(x)\,dA_x
=\sum_{e}\sum_{a=1}^{4}\delta_{i,\,\text{glob}(e,a)}\ \int_{e} N_a(x)\,E(x)\,dA .
$$

* 若 $E$ 在单元上常数 $E_e$，则 $f^{(e)}=E_e\cdot M^{(e)}\mathbf{1}$（$\mathbf{1}$ 为全 1 向量）装配入全局即可。

---

# 4) 核矩阵 $K$（双重面积分）

$$
K_{ij}=\iint_{S\times S}\phi_i(x)\,\rho(x)\,G(x,y)\,V(x,y)\,\phi_j(y)\,dA_y\,dA_x .
$$

按**单元对**装配：对任意两单元 $e$ 与 $e'$，其**局部 4×4 耦合块**为

$$
K^{(e,e')}_{ab}
=\iint_{e\times e'}\rho(x)\,N_a^{(e)}(x)\,G(x,y)\,V(x,y)\,N_b^{(e')}(y)\,dA_y\,dA_x,
\quad a,b\in\{1,2,3,4\}.
$$

数值上用张量高斯积分（$(q\xi,q\eta)$ 与 $(p\xi,p\eta)$）：

$$
K^{(e,e')}_{ab}\approx
\sum_{q=1}^{n_q}\sum_{p=1}^{n_q}
\rho(x_q)\,N_a(x_q)\,G(x_q,y_p)\,V(x_q,y_p)\,N_b(y_p)\,(w_q h^2)(w_p h^2),
$$

其中 $x_q=\mathbf{x}_e(\xi_q,\eta_q)$, $y_p=\mathbf{x}_{e'}(\xi'_p,\eta'_p)$。
**可见性 $V\in\{0,1\}$**（或半影时介于 0–1），$G(x,y)=\dfrac{\cos\theta_x\cos\theta_y}{\pi\,\|x-y\|^2}$（同向半球外置 0；自耦合不计）。
全局装配：把 $K^{(e,e')}$ 通过 $\mathcal{A}_e,\mathcal{A}_{e'}$ 加到 $K$ 的相应 16 个条目中。

> 计算建议
>
> * 远场对 $(e,e')$：$n_q=2$ 或 $3$ 足够；
> * 近邻/共面接近奇异：提高到 $n_q=6$ 或做**自适应细分积分**；
> * 互易修正：装配后用 $A$-加权对称化 $K\leftarrow\frac12(K+K^\top)$（若 $V$ 对称），稳定且更物理。

---

# 5) “$R\,F$”分解（可选但常用）

有人喜欢把“反照率”和“几何核”拆开，写成 $(M-RF)b=f$。做法是把上式中的 $\rho(x)$ 投影到基空间：

$$
R_{ik}=\int_S \phi_i(x)\,\rho(x)\,\phi_k(x)\,dA_x,\quad
F_{kj}=\iint_{S\times S}\phi_k(x)\,G(x,y)V(x,y)\,\phi_j(y)\,dA_y dA_x,
$$

则

$$
K=R\,F,\qquad (M-RF)\,b=f.
$$

* 若 $\rho$ 在**单元常数** $\rho_e$，则 $R$ 的单元块就是 $\rho_e\,M^{(e)}$（再装配）；
* $F$ 的块与上面的 $K$ 类似，只是没有 $\rho(x)$。

---

# 6) 小结（你需要实现的 3 个局部块）

在等距正方形网格 + Q1 基下，装配只需这三样：

1. **质量块** $M^{(e)}=\dfrac{h^2}{36}\begin{bmatrix}4&2&2&1\\2&4&1&2\\2&1&4&2\\1&2&2&4\end{bmatrix}$。
2. **几何核块**（无 $\rho$）：
   $\displaystyle F^{(e,e')}_{ab}\approx \sum_{q,p} N_a(x_q) G(x_q,y_p) V(x_q,y_p) N_b(y_p)\,(w_q h^2)(w_p h^2).$
3. **反照率块**（可选）：$R^{(e)}=\rho_e\,M^{(e)}$。

把它们装起来就是

$$
\boxed{(M-K)\,b=f\quad\text{或}\quad(M-RF)\,b=f.}
$$

---

**实用提醒**

* **自耦合**与**同面近奇异**：跳过自耦合；同面但不重叠的近邻用更高阶积分或奇异性分解（减去 $1/r^2$ 的局部主导项再加回解析项）。
* **能量守恒**：装配后做一次**行/列和归一**（Sinkhorn）把误差压到 $10^{-4}$ 量级，数值更稳。
* **阴影硬边**：P1/Q1 会平滑解；在阴影边界用 **h 细分**（上一问里的做法）比“再升 P”更靠谱。

如果你愿意给我网格步长 $h$、光源/几何的确切摆放，我可以把近邻判据、积分阶数（远/近场）和可见性缓存策略写成一张**装配参数表**，直接照着填代码。
